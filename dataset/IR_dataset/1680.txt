در ۱۷۹۶، روس‌ها به تلافی حمله یک سال قبل آغامحمدخان به تفلیس، به قفقاز لشکر کشیدند و در مدت کوتاهی خوانین منطقه را تابع خود کردند. در این زمان، آغامحمدخان در خراسان بود که خبر حمله روس‌ها به او رسید. او سپاه خود را برداشت و خود را به تهران رساند. در تهران به نیروهای نظامی ولایات دستور داد که با سربازانشان خود را به او برسانند تا بهار سال آینده با روس‌ها روبرو شوند. ظاهراً انتظار داشت که این حمله به درازا بکشد؛ زیرا فتحعلی را نایب‌السلطنه خود اعلام کرد. او میرزا شفیع‌صدر و میرزا محمدخان قاجار که از معتمدانش بودند را به حاکمیت تهران گماشت و به آن‌ها امر کرد در صورتی که اتفاقی افتاد، تا زمان ورود فتحعلی از فارس کسی را به شهر راه ندهند. شاه در ژوئن ۱۷۹۷ تهران را ترک کرد. او افرادی که بیم داشت که در صورت عدم بازگشتش برای به سلطنت رسیدن نایب‌السلطنه دردسر ایجاد کنند را هم با خود برد. همچنین حاج ابراهیم هم همراهش بود.

آغامحمدخان در سلطانیه اردو زده بود که از عقب‌نشینی روس‌ها به دلیل مرگ کاترین کبیر مطلع شد. او، که دیگر فوریتی در رساندن خود به گرجستان نمی‌دید، تصمیم گرفت خوانین محلی را سرکوب کند. پس از چندی درگیری، موفق شد به شوشی، مرکز قره‌باغ، وارد شود. آغامحمدخان در شوشی توسط سه خدمتکار و احتمالاً با توطئه خوانین محلی یا سرداران سپاهش به رهبری صادق‌خان شقاقی به قتل رسید.

با کشته شدن آغامحمدخان، آشفتگی بر سپاه او چیره شد. صادق‌خان که به قاتلان او پناه داده بود، با یاری سران ایل شاهسون اردوی شاه در شوشی را به غارت برد و به تبریز تاخت. حاج ابراهیم که با نیروهای اصلی سپاه در آدینه‌بازار نزدیک اردبیل بود، تلاش کرد نظم را به اردوی شاه مقتول بازگرداند. او گروهی را به فرماندهی حسینقلی‌خان (برادر فتحعلی‌شاه) از راه تالش، شفت و رشت به تهران فرستاد و خود با تفنگچیان فارسی و مازندرانی از اردبیل و زنجان راه دارالخلافه در پیش گرفت.